<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>博物馆环境监控系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2em;
        }
        
        .connection-panel {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #ddd;
        }
        
        #connectBtn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        #connectBtn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        #connectBtn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .sensor-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid #007bff;
        }
        
        .sensor-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        
        .sensor-value {
            font-size: 32px;
            font-weight: bold;
            color: #007bff;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .threshold-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .threshold-label {
            font-size: 14px;
            color: #666;
        }
        
        .threshold-value {
            font-weight: bold;
            color: #333;
        }
        
        .threshold-buttons {
            display: flex;
            gap: 5px;
        }
        
        .btn {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .btn-add {
            background: #28a745;
            color: white;
        }
        
        .btn-add:hover {
            background: #218838;
        }
        
        .btn-reduce {
            background: #dc3545;
            color: white;
        }
        
        .btn-reduce:hover {
            background: #c82333;
        }
        
        .alarm-panel {
            text-align: center;
            padding: 20px;
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .data-collection-panel {
            text-align: center;
            padding: 20px;
            background: #d4edda;
            border: 2px solid #c3e6cb;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .data-collection-panel h3 {
            color: #155724;
            margin-bottom: 10px;
        }
        
        .ai-panel {
            text-align: center;
            padding: 20px;
            background: #e3f2fd;
            border: 2px solid #bbdefb;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .ai-panel h3 {
            color: #1565c0;
            margin-bottom: 10px;
        }
        
        #aiResults {
            text-align: left;
            line-height: 1.6;
        }
        
        .ai-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            font-style: italic;
            color: #6c757d;
        }
        
        .ai-alert {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
        }
        
        .ai-suggestion {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
        }
        
        .ai-prediction {
            background: #e2e3e5;
            border: 1px solid #d6d8db;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
        }
        
        #alarmBtn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s ease;
            animation: pulse 2s infinite;
        }
        
        #alarmBtn:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
            }
        }
        
        .status-bar {
            background: #e9ecef;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            color: #666;
        }
        
        .status-connected {
            color: #28a745;
            font-weight: bold;
        }
        
        .status-disconnected {
            color: #dc3545;
            font-weight: bold;
        }
        
        .alert {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            text-align: center;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js"></script>
<script>
  // 替换为您的Firebase配置
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    databaseURL: "YOUR_DATABASE_URL",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  // 初始化Firebase
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
</script>
</head>
<body>
    <div class="container">
        <h1>博物馆环境监控系统</h1>
        
        <div class="connection-panel">
            <button id="connectBtn">连接串口</button>
            <button id="simulateBtn" onclick="startSimulation()" style="margin-left: 10px; background: #6f42c1; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">模拟数据</button>
            <div id="status" class="status-bar">
                状态: <span class="status-disconnected">未连接</span>
            </div>
        </div>
        
        <div class="sensor-grid">
            <div class="sensor-card">
                <div class="sensor-title">烟雾传感器 (MQ-2)</div>
                <div class="sensor-value" id="mq2Value">--</div>
                <div class="threshold-controls">
                    <span class="threshold-label">最大阈值:</span>
                    <span class="threshold-value" id="mq2Max">60</span>
                    <div class="threshold-buttons">
                        <button class="btn btn-add" onclick="updateThreshold('MQ', 'max', 'add')">+</button>
                        <button class="btn btn-reduce" onclick="updateThreshold('MQ', 'max', 'reduce')">-</button>
                    </div>
                </div>
                <div class="threshold-controls">
                    <span class="threshold-label">最小阈值:</span>
                    <span class="threshold-value" id="mq2Min">30</span>
                    <div class="threshold-buttons">
                        <button class="btn btn-add" onclick="updateThreshold('MQ', 'min', 'add')">+</button>
                        <button class="btn btn-reduce" onclick="updateThreshold('MQ', 'min', 'reduce')">-</button>
                    </div>
                </div>
            </div>
            
            <div class="sensor-card">
                <div class="sensor-title">温度传感器 (DHT11)</div>
                <div class="sensor-value" id="tempValue">--</div>
                <div class="threshold-controls">
                    <span class="threshold-label">最大阈值:</span>
                    <span class="threshold-value" id="tempMax">37</span>
                    <div class="threshold-buttons">
                        <button class="btn btn-add" onclick="updateThreshold('Temp', 'max', 'add')">+</button>
                        <button class="btn btn-reduce" onclick="updateThreshold('Temp', 'max', 'reduce')">-</button>
                    </div>
                </div>
                <div class="threshold-controls">
                    <span class="threshold-label">最小阈值:</span>
                    <span class="threshold-value" id="tempMin">10</span>
                    <div class="threshold-buttons">
                        <button class="btn btn-add" onclick="updateThreshold('Temp', 'min', 'add')">+</button>
                        <button class="btn btn-reduce" onclick="updateThreshold('Temp', 'min', 'reduce')">-</button>
                    </div>
                </div>
            </div>
            
            <div class="sensor-card">
                <div class="sensor-title">湿度传感器 (DHT11)</div>
                <div class="sensor-value" id="humValue">--</div>
                <div class="threshold-controls">
                    <span class="threshold-label">最大阈值:</span>
                    <span class="threshold-value" id="humMax">70</span>
                    <div class="threshold-buttons">
                        <button class="btn btn-add" onclick="updateThreshold('Hum', 'max', 'add')">+</button>
                        <button class="btn btn-reduce" onclick="updateThreshold('Hum', 'max', 'reduce')">-</button>
                    </div>
                </div>
                <div class="threshold-controls">
                    <span class="threshold-label">最小阈值:</span>
                    <span class="threshold-value" id="humMin">20</span>
                    <div class="threshold-buttons">
                        <button class="btn btn-add" onclick="updateThreshold('Hum', 'min', 'add')">+</button>
                        <button class="btn btn-reduce" onclick="updateThreshold('Hum', 'min', 'reduce')">-</button>
                    </div>
                </div>
            </div>
            
            <div class="sensor-card">
                <div class="sensor-title">超声波传感器 (HC-SR04)</div>
                <div class="sensor-value" id="hcsr04Value">--</div>
                <div class="threshold-controls">
                    <span class="threshold-label">最大阈值:</span>
                    <span class="threshold-value" id="hcsr04Max">15</span>
                    <div class="threshold-buttons">
                        <button class="btn btn-add" onclick="updateThreshold('HCSR04', 'max', 'add')">+</button>
                        <button class="btn btn-reduce" onclick="updateThreshold('HCSR04', 'max', 'reduce')">-</button>
                    </div>
                </div>
                <div class="threshold-controls">
                    <span class="threshold-label">最小阈值:</span>
                    <span class="threshold-value" id="hcsr04Min">1</span>
                    <div class="threshold-buttons">
                        <button class="btn btn-add" onclick="updateThreshold('HCSR04', 'min', 'add')">+</button>
                        <button class="btn btn-reduce" onclick="updateThreshold('HCSR04', 'min', 'reduce')">-</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="alarm-panel">
            <h3>手动报警控制</h3>
            <button id="alarmBtn">触发报警</button>
            <div id="alarmStatus" style="margin-top: 10px;"></div>
        </div>
        
        <div class="ai-panel">
            <h3>AI 智能分析</h3>
            <div style="display: flex; justify-content: center; gap: 15px; margin-top: 15px;">
                <button id="aiAnalyzeBtn" class="btn" style="background: #17a2b8; color: white;">分析异常</button>
                <button id="aiPredictBtn" class="btn" style="background: #6f42c1; color: white;">预测趋势</button>
                <button id="aiOptimizeBtn" class="btn" style="background: #28a745; color: white;">节能建议</button>
            </div>
            <div id="aiResults" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; min-height: 100px;">
                <p style="color: #6c757d; text-align: center;">点击上方按钮获取AI分析结果</p>
            </div>
        </div>
        
        <div class="data-collection-panel">
            <h3>数据收集</h3>
            <div style="display: flex; justify-content: center; gap: 15px; margin-top: 15px;">
                <button id="startCollectBtn" class="btn btn-add">开始收集</button>
                <button id="stopCollectBtn" class="btn btn-reduce" disabled>停止收集</button>
                <button id="downloadBtn" class="btn" style="background: #007bff; color: white;">下载表格</button>
            </div>
            <div id="collectStatus" style="margin-top: 10px; font-size: 14px; color: #666;">未收集数据</div>
        </div>
        
        <div class="status-bar">
            <div>数据更新时间: <span id="lastUpdate">--</span></div>
            <div id="serialOutput" style="margin-top: 5px; font-family: monospace; white-space: pre-wrap; max-height: 100px; overflow-y: auto;"></div>
        </div>
    </div>
    
    <script>
        let port;
        let serialReader;
        let isConnected = false;
        let receivedData = '';
        let readLoopActive = false;
        let isSimulating = false;
        let simulateInterval;
        
        // 页面加载时检查浏览器兼容性
        let cloudSyncEnabled = false;

// 在数据收集面板中添加云同步按钮
const collectionPanel = document.querySelector('.data-collection-panel');
const syncButtonHTML = `
  <button id="cloudSyncBtn" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; margin: 0 10px;">开始云同步</button>
`;
collectionPanel.querySelector('.button-group').innerHTML += syncButtonHTML;

// 云同步按钮事件监听
document.getElementById('cloudSyncBtn').addEventListener('click', toggleCloudSync);

function toggleCloudSync() {
    cloudSyncEnabled = !cloudSyncEnabled;
    const syncBtn = document.getElementById('cloudSyncBtn');
    syncBtn.textContent = cloudSyncEnabled ? '停止云同步' : '开始云同步';
    syncBtn.style.background = cloudSyncEnabled ? '#dc3545' : '#007bff';
}

// 上传数据到Firebase
async function uploadToCloud(data) {
    try {
        // 替换为您的Cloud Function URL
        const functionUrl = 'https://us-central1-museum-monitor-db.cloudfunctions.net/uploadSensorData';
        
        const response = await fetch(functionUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (response.status !== 200) {
            console.error('数据上传失败:', result.message);
        }
    } catch (error) {
        console.error('网络错误:', error);
    }
}

// 修改collectData函数，添加云同步逻辑
function collectData(data) {
    if (isCollecting) {
        const timestamp = new Date().toISOString();
        const dataWithTime = {
            timestamp: timestamp,
            mq2: data.mq2,
            temperature: data.temperature,
            humidity: data.humidity,
            hcsr04: data.hcsr04
        };
        collectedData.push(dataWithTime);
        
        // 如果开启云同步，则上传数据
        if (cloudSyncEnabled) {
            uploadToCloud(dataWithTime);
        }
        
        updateCollectionStatus();
    }
}
        window.addEventListener('load', () => {
            if (!navigator.serial) {
                const alertElement = document.createElement('div');
                alertElement.className = 'alert';
                alertElement.innerHTML = '<strong>浏览器兼容性警告：</strong>您的浏览器不支持 Web Serial API。请使用 Chrome 89+ 或 Edge 89+ 桌面浏览器访问此页面。';
                document.body.insertBefore(alertElement, document.body.firstChild);
            }
        });
        
        // 初始化阈值显示
        const initialThresholds = {
            mq2: { max: 60, min: 30 },
            temp: { max: 37, min: 10 },
            hum: { max: 70, min: 20 },
            hcsr04: { max: 15, min: 1 }
        };
        
        async function connectSerial() {
            // 检查浏览器是否支持Web Serial API
            if (!navigator.serial) {
                document.getElementById('status').innerHTML = `
                    状态: <span class="status-disconnected">不支持</span>
                    <div class="alert">您的浏览器不支持Web Serial API。请使用Chrome 89+或Edge 89+浏览器。</div>
                `;
                return;
            }
            
            try {
                // 请求用户选择串口设备
                port = await navigator.serial.requestPort();
                
                // 打开串口
                await port.open({ baudRate: 9600 });
                
                // 重置接收缓冲区
                receivedData = '';
                
                // 更新连接状态
                isConnected = true;
                updateConnectionStatus();
                
                // 开始读取数据
                startReading();
                
                console.log('串口连接成功');
            } catch (error) {
                console.error('串口连接失败:', error);
                
                // 根据错误类型显示不同的错误信息
                let errorMessage = '未知错误';
                if (error.name === 'NotFoundError') {
                    errorMessage = '请选择一个有效的串口设备。如果没有看到设备列表，请检查设备是否正确连接。';
                } else if (error.name === 'SecurityError') {
                    errorMessage = '访问串口设备被拒绝。请确保您有权限访问该设备。';
                } else if (error.name === 'NetworkError') {
                    errorMessage = '无法打开串口设备。该设备可能被其他程序占用。';
                } else if (error.name === 'AbortError') {
                    errorMessage = '用户取消了设备选择。';
                } else {
                    errorMessage = error.message;
                }
                
                document.getElementById('status').innerHTML = `
                    状态: <span class="status-disconnected">连接失败</span>
                    <div class="alert">${errorMessage}</div>
                `;
            }
        }
        
        function updateConnectionStatus() {
            const statusElement = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            
            if (isConnected) {
                statusElement.innerHTML = '状态: <span class="status-connected">已连接</span>';
                connectBtn.textContent = '断开连接';
                connectBtn.onclick = disconnectSerial;
            } else {
                statusElement.innerHTML = '状态: <span class="status-disconnected">未连接</span>';
                connectBtn.textContent = '连接串口';
                connectBtn.onclick = connectSerial;
            }
        }
        
        async function disconnectSerial() {
            // 如果是模拟模式，直接停止模拟
            if (isSimulating) {
                stopSimulation();
                return;
            }
            
            if (port) {
                try {
                    // 标记读取循环应该停止
                    readLoopActive = false;
                    
                    // 释放reader锁（如果存在）
                    if (serialReader) {
                        await serialReader.releaseLock();
                        serialReader = null;
                    }
                    
                    // 关闭端口
                    await port.close();
                    
                    // 更新状态
                    isConnected = false;
                    updateConnectionStatus();
                    
                    console.log('串口已断开连接');
                } catch (error) {
                    console.error('断开串口连接时出错:', error);
                } finally {
                    port = null;
                }
            }
        }
        
        async function startReading() {
            if (!port) return;
            
            try {
                const decoder = new TextDecoderStream();
                const readableStreamClosed = port.readable.pipeTo(decoder.writable);
                serialReader = decoder.readable.getReader();
                readLoopActive = true;
                
                console.log('开始读取串口数据');
                
                while (readLoopActive) {
                    try {
                        // 添加超时处理，避免读取操作无限期等待
                        const readPromise = serialReader.read();
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('读取超时')), 5000) // 增加超时时间到5秒
                        );
                        
                        // 使用Promise.race来实现超时控制
                        const { value, done } = await Promise.race([readPromise, timeoutPromise]);
                        
                        if (done || !readLoopActive) {
                            break;
                        }
                        
                        // 添加接收到的数据到缓冲区
                        receivedData += value;
                        
                        // 处理接收到的数据
                        processSerialData();
                    } catch (readError) {
                        // 只在非超时错误时打印详细错误信息
                        if (readError.message !== '读取超时') {
                            console.error('单次读取数据失败:', readError);
                        }
                        
                        // 如果是读取超时，静默处理并继续尝试读取，而不是终止整个读取循环
                        if (readError.message === '读取超时') {
                            // 不打印超时日志，避免控制台混乱
                            continue;
                        }
                        
                        // 其他错误，终止读取循环
                        break;
                    }
                }
                
                console.log('停止读取串口数据');
            } catch (error) {
                console.error('读取串口数据失败:', error);
                
                // 如果是因为端口错误（比如设备被拔出），更新连接状态
                if (error.name === 'NetworkError' || error.name === 'TypeError') {
                    isConnected = false;
                    updateConnectionStatus();
                    
                    document.getElementById('status').innerHTML = `
                        状态: <span class="status-disconnected">连接丢失</span>
                        <div class="alert">串口连接已丢失。设备可能被拔出或发生错误。</div>
                    `;
                }
            } finally {
                // 确保释放reader锁
                if (serialReader) {
                    try {
                        await serialReader.releaseLock();
                    } catch (e) {
                        // 忽略释放锁时可能发生的错误
                    }
                    serialReader = null;
                }
                
                readLoopActive = false;
            }
        }
        
        function processSerialData() {
            // 更新原始数据显示（只显示最近的1000个字符）
            const serialOutput = document.getElementById('serialOutput');
            if (serialOutput) {
                serialOutput.textContent = receivedData.slice(-1000);
            }
            
            // 查找完整的数据块（以换行符分隔）
            const lines = receivedData.split('\n');
            
            // 保留最后一行（可能是不完整的数据）
            if (lines.length > 1) {
                receivedData = lines[lines.length - 1];
                
                // 处理所有完整的行
                for (let i = 0; i < lines.length - 1; i++) {
                    parseSensorData(lines[i]);
                }
            }
        }
        
        // 用于跟踪阈值数据接收顺序的计数器
        let thresholdCounter = 0;
        
        function parseSensorData(line) {
            // 尝试将行解析为数字（可能是阈值数据）
            const numericValue = parseInt(line.trim());
            
            // 如果是有效的数字，并且不是传感器数据行，那么可能是阈值数据
            if (!isNaN(numericValue) && !line.includes(':') && !line.includes('Alarm') && !line.includes('is ok')) {
                processThresholdData(numericValue);
                return; // 处理完阈值数据后直接返回
            }
            
            // 解析MQ-2烟雾传感器数据
            if (line.includes('MQ-2:')) {
                const match = line.match(/MQ-2:(\d+)/);
                if (match) {
                    const value = match[1] + '%';
                    document.getElementById('mq2Value').textContent = value;
                    updateLastTime();
                }
            }
            
            // 解析温度数据
            if (line.includes('Temp:')) {
                const match = line.match(/Temp:(\d+)\.(\d+)C/);
                if (match) {
                    const value = match[1] + '.' + match[2] + '°C';
                    document.getElementById('tempValue').textContent = value;
                    updateLastTime();
                }
            }
            
            // 解析湿度数据
            if (line.includes('Hum:')) {
                const match = line.match(/Hum:(\d+)\.(\d+)%/);
                if (match) {
                    const value = match[1] + '.' + match[2] + '%';
                    document.getElementById('humValue').textContent = value;
                    updateLastTime();
                }
            }
            
            // 解析超声波传感器数据
            if (line.includes('HC-SR04:')) {
                const match = line.match(/HC-SR04:(\d+)cm/);
                if (match) {
                    const value = match[1] + 'cm';
                    document.getElementById('hcsr04Value').textContent = value;
                    updateLastTime();
                }
            }
            
            // 解析阈值确认消息
            if (line.includes('is ok')) {
                console.log('阈值调整成功确认');
                // 重置阈值计数器，因为新的阈值调整开始了
                thresholdCounter = 0;
            }
            
            // 解析报警触发消息
            if (line.includes('Alarm triggered')) {
                const statusElement = document.getElementById('alarmStatus');
                const alarmBtn = document.getElementById('alarmBtn');
                
                // 根据当前状态更新显示
                if (isAlarmActive) {
                    alarmBtn.textContent = '取消报警';
                    alarmBtn.style.background = '#ffc107';
                    alarmBtn.style.color = '#333';
                    statusElement.textContent = '报警已触发！';
                    statusElement.style.color = '#dc3545';
                } else {
                    alarmBtn.textContent = '触发报警';
                    alarmBtn.style.background = '#dc3545';
                    alarmBtn.style.color = 'white';
                    statusElement.textContent = '报警已取消！';
                    statusElement.style.color = '#28a745';
                }
            }
        }
        
        // 处理从STM32发送过来的阈值数据
        function processThresholdData(value) {
            console.log(`收到阈值数据 #${thresholdCounter}: ${value}`);
            
            // 根据计数器的值确定当前接收的是哪个阈值
            // 发送顺序：MQ_2_Max, MQ_2_Min, Temp_Max, Temp_Min, Hum_Max, Hum_Min, HCSR04_Max, HCSR04_Min
            let elementId = '';
            
            switch (thresholdCounter) {
                case 0:
                    elementId = 'mq2Max';
                    break;
                case 1:
                    elementId = 'mq2Min';
                    break;
                case 2:
                    elementId = 'tempMax';
                    break;
                case 3:
                    elementId = 'tempMin';
                    break;
                case 4:
                    elementId = 'humMax';
                    break;
                case 5:
                    elementId = 'humMin';
                    break;
                case 6:
                    elementId = 'hcsr04Max';
                    break;
                case 7:
                    elementId = 'hcsr04Min';
                    break;
                default:
                    // 如果计数器超出范围，可能是新的一轮开始，重置计数器
                    console.log('阈值计数器超出范围，重置为0');
                    thresholdCounter = 0;
                    elementId = 'mq2Max';
                    break;
            }
            
            // 更新页面上的阈值显示
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value;
                console.log(`更新阈值 ${elementId} 为 ${value}`);
            }
            
            // 增加计数器，准备接收下一个阈值
            thresholdCounter++;
            
            // 如果已经接收了8个阈值（一轮完整的数据），重置计数器
            if (thresholdCounter >= 8) {
                console.log('完成一轮阈值数据接收，重置计数器');
                thresholdCounter = 0;
            }
        }
        
        function updateLastTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN');
            document.getElementById('lastUpdate').textContent = timeString;
        }
        
        async function sendCommand(command) {
            if (!isConnected || !port) {
                alert('请先连接串口！');
                return;
            }
            
            try {
                const writer = port.writable.getWriter();
                const encoder = new TextEncoder();
                
                // 添加超时处理，避免写入操作无限期等待
                const writePromise = writer.write(encoder.encode(command + '\n'));
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('写入超时')), 1000)
                );
                
                // 使用Promise.race来实现超时控制
                await Promise.race([writePromise, timeoutPromise]);
                
                writer.releaseLock();
            } catch (error) {
                console.error('发送命令失败:', error);
                
                // 显示错误提示，但不阻塞界面
                const statusElement = document.getElementById('status');
                statusElement.innerHTML += `
                    <div class="alert">发送命令失败: ${error.message}</div>
                `;
            }
        }
        
        function updateThreshold(sensor, type, action) {
            const command = `${sensor} ${type} ${action}`;
            sendCommand(command);
            
            // 更新本地显示的阈值（实际应该等待设备返回确认）
            const elementId = sensor.toLowerCase() + type.charAt(0).toUpperCase() + type.slice(1);
            const element = document.getElementById(elementId);
            if (element) {
                let currentValue = parseInt(element.textContent);
                if (action === 'add') {
                    currentValue++;
                } else {
                    currentValue--;
                }
                element.textContent = currentValue;
            }
        }
        
        // 添加变量来跟踪报警状态
        let isAlarmActive = false;
        
        document.getElementById('alarmBtn').addEventListener('click', async () => {
            if (!isConnected) {
                alert('请先连接串口！');
                return;
            }
            
            try {
                // 切换报警状态
                isAlarmActive = !isAlarmActive;
                
                // 发送报警命令
                await sendCommand('alarm');
                
                // 更新按钮文本和样式
                const alarmBtn = document.getElementById('alarmBtn');
                const statusElement = document.getElementById('alarmStatus');
                
                if (isAlarmActive) {
                    alarmBtn.textContent = '取消报警';
                    alarmBtn.style.background = '#ffc107';
                    alarmBtn.style.color = '#333';
                    statusElement.textContent = '报警已触发！';
                    statusElement.style.color = '#dc3545';
                } else {
                    alarmBtn.textContent = '触发报警';
                    alarmBtn.style.background = '#dc3545';
                    alarmBtn.style.color = 'white';
                    statusElement.textContent = '报警已取消！';
                    statusElement.style.color = '#28a745';
                }
                
                // 报警状态不会自动清除，会一直显示直到状态改变
                
            } catch (error) {
                console.error('操作报警失败:', error);
                
                // 出错时恢复原状态
                isAlarmActive = !isAlarmActive;
                const statusElement = document.getElementById('alarmStatus');
                statusElement.textContent = '操作失败，请重试';
                statusElement.style.color = '#6c757d';
            }
        });
        
        // 初始化
        document.getElementById('connectBtn').onclick = connectSerial;
        
        // 更新初始阈值显示
        Object.keys(initialThresholds).forEach(sensor => {
            document.getElementById(`${sensor}Max`).textContent = initialThresholds[sensor].max;
            document.getElementById(`${sensor}Min`).textContent = initialThresholds[sensor].min;
        });
        
        // 添加模拟数据功能
        function startSimulation() {
            if (isConnected) {
                alert('已连接到真实设备，无法启动模拟！');
                return;
            }
            
            isSimulating = true;
            isConnected = true;
            updateConnectionStatus();
            
            // 模拟串口数据
            simulateInterval = setInterval(() => {
                // 生成随机传感器数据
                const mq2 = Math.floor(Math.random() * 30) + 40; // 40-70%
                const temp = (Math.random() * 10 + 25).toFixed(1); // 25.0-35.0°C
                const hum = (Math.random() * 20 + 50).toFixed(1); // 50.0-70.0%
                const hcsr04 = Math.floor(Math.random() * 10) + 5; // 5-15cm
                
                // 更新页面显示
                document.getElementById('mq2Value').textContent = mq2 + '%';
                document.getElementById('tempValue').textContent = temp + '°C';
                document.getElementById('humValue').textContent = hum + '%';
                document.getElementById('hcsr04Value').textContent = hcsr04 + 'cm';
                updateLastTime();
                
                // 更新全局传感器数据
                window.sensorData = {
                    mq2: mq2,
                    temperature: parseFloat(temp),
                    humidity: parseFloat(hum),
                    hcsr04: hcsr04,
                    mq2Alarm: false,
                    temperatureAlarm: false,
                    humidityAlarm: false,
                    hcsr04Alarm: false
                };
                
                // 收集数据
                collectData(window.sensorData);
            }, 1000);
            
            console.log('模拟数据已启动');
        }
        
        function stopSimulation() {
            if (!isSimulating) return;
            
            isSimulating = false;
            isConnected = false;
            updateConnectionStatus();
            
            clearInterval(simulateInterval);
            console.log('模拟数据已停止');
        }
        
        // ======================= 数据收集功能 =======================
        let isCollecting = false;
        let collectedData = [];
        let collectInterval;
        
        // 开始收集数据
        document.getElementById('startCollectBtn').addEventListener('click', () => {
            if (!isConnected) {
                alert('请先连接串口！');
                return;
            }
            
            isCollecting = true;
            collectedData = [];
            
            document.getElementById('startCollectBtn').disabled = true;
            document.getElementById('stopCollectBtn').disabled = false;
            document.getElementById('collectStatus').innerHTML = 
                '<span style="color: #28a745; font-weight: bold;">数据收集已开始</span>';
        });
        
        // 停止收集数据
        document.getElementById('stopCollectBtn').addEventListener('click', () => {
            isCollecting = false;
            
            document.getElementById('startCollectBtn').disabled = false;
            document.getElementById('stopCollectBtn').disabled = true;
            document.getElementById('collectStatus').innerHTML = 
                `<span style="color: #6c757d;">数据收集已停止，共收集了 <strong>${collectedData.length}</strong> 条记录</span>`;
        });
        
        // 收集数据的函数
        function collectData(sensorData) {
            if (!isCollecting) return;
            
            const timestamp = new Date().toLocaleString();
            
            const dataRecord = {
                timestamp: timestamp,
                mq2: sensorData.mq2 || 0,
                temperature: sensorData.temperature || 0,
                humidity: sensorData.humidity || 0,
                hcsr04: sensorData.hcsr04 || 0,
                mq2Alarm: sensorData.mq2Alarm ? '是' : '否',
                temperatureAlarm: sensorData.temperatureAlarm ? '是' : '否',
                humidityAlarm: sensorData.humidityAlarm ? '是' : '否',
                hcsr04Alarm: sensorData.hcsr04Alarm ? '是' : '否'
            };
            
            collectedData.push(dataRecord);
            
            // 更新状态显示
            document.getElementById('collectStatus').innerHTML = 
                `<span style="color: #28a745; font-weight: bold;">数据收集已开始 - 已收集 ${collectedData.length} 条记录</span>`;
        }
        
        // 下载数据表格（CSV格式）
        document.getElementById('downloadBtn').addEventListener('click', () => {
            if (collectedData.length === 0) {
                alert('没有可下载的数据！请先开始收集数据。');
                return;
            }
            
            // 构建CSV内容
            let csvContent = '时间戳,烟雾值(MQ-2),温度(°C),湿度(%),距离(cm),烟雾报警,温度报警,湿度报警,距离报警\n';
            
            collectedData.forEach(record => {
                csvContent += `${record.timestamp},${record.mq2},${record.temperature},${record.humidity},${record.hcsr04},${record.mq2Alarm},${record.temperatureAlarm},${record.humidityAlarm},${record.hcsr04Alarm}\n`;
            });
            
            // 创建Blob并下载
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `博物馆环境数据_${new Date().toISOString().slice(0, 10)}_${new Date().getHours()}${new Date().getMinutes()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        // 初始化全局传感器数据对象
        window.sensorData = {
            mq2: 0,
            temperature: 0,
            humidity: 0,
            hcsr04: 0,
            mq2Alarm: false,
            temperatureAlarm: false,
            humidityAlarm: false,
            hcsr04Alarm: false
        };
        
        // 修改parseSensorData函数，在解析数据时更新全局传感器数据并收集
        const originalParseSensorData = parseSensorData;
        parseSensorData = function(line) {
            // 调用原始函数更新页面
            originalParseSensorData(line);
            
            // 解析MQ-2烟雾传感器数据
            if (line.includes('MQ-2:')) {
                const match = line.match(/MQ-2:(\d+)/);
                if (match) {
                    window.sensorData.mq2 = parseInt(match[1]);
                }
            }
            
            // 解析温度数据
            if (line.includes('Temp:')) {
                const match = line.match(/Temp:(\d+)\.(\d+)C/);
                if (match) {
                    window.sensorData.temperature = parseFloat(match[1] + '.' + match[2]);
                }
            }
            
            // 解析湿度数据
            if (line.includes('Hum:')) {
                const match = line.match(/Hum:(\d+)\.(\d+)%/);
                if (match) {
                    window.sensorData.humidity = parseFloat(match[1] + '.' + match[2]);
                }
            }
            
            // 解析超声波传感器数据
            if (line.includes('HC-SR04:')) {
                const match = line.match(/HC-SR04:(\d+)cm/);
                if (match) {
                    window.sensorData.hcsr04 = parseInt(match[1]);
                }
            }
            
            // 解析报警数据
            if (line.includes('Alarm')) {
                // MQ-2报警
                if (line.includes('MQ-2 Alarm')) {
                    window.sensorData.mq2Alarm = true;
                }
                // 温度报警
                if (line.includes('Temperature Alarm')) {
                    window.sensorData.temperatureAlarm = true;
                }
                // 湿度报警
                if (line.includes('Humidity Alarm')) {
                    window.sensorData.humidityAlarm = true;
                }
                // 超声波报警
                if (line.includes('HC-SR04 Alarm')) {
                    window.sensorData.hcsr04Alarm = true;
                }
            }
            
            // 解析正常状态数据
            if (line.includes('is ok')) {
                // MQ-2正常
                if (line.includes('MQ-2 is ok')) {
                    window.sensorData.mq2Alarm = false;
                }
                // 温度正常
                if (line.includes('Temperature is ok')) {
                    window.sensorData.temperatureAlarm = false;
                }
                // 湿度正常
                if (line.includes('Humidity is ok')) {
                    window.sensorData.humidityAlarm = false;
                }
                // 超声波正常
                if (line.includes('HC-SR04 is ok')) {
                    window.sensorData.hcsr04Alarm = false;
                }
            }
            
            // 收集数据
            collectData(window.sensorData);
        };
        
        // ======================= AI 智能分析功能 =======================
        
        // 模拟AI API调用函数
        async function callAIApi(endpoint, data) {
            // 显示加载状态
            const aiResults = document.getElementById('aiResults');
            aiResults.innerHTML = '<div class="ai-loading">正在分析数据，请稍候...</div>';
            
            // 模拟API延迟
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // 模拟不同端点的AI响应
            switch (endpoint) {
                case 'analyze':
                    return analyzeAnomalies(data);
                case 'predict':
                    return predictTrends(data);
                case 'optimize':
                    return optimizeEnergy(data);
                default:
                    return { error: '未知端点' };
            }
        }
        
        // 异常检测功能
        function analyzeAnomalies(data) {
            // 检查是否有足够的数据进行分析
            if (collectedData.length < 10) {
                return { message: '数据不足，无法进行异常分析。请至少收集10分钟的数据。' };
            }
            
            // 分析异常
            let anomalies = [];
            
            // 检查烟雾值异常
            const mq2Values = collectedData.map(d => d.mq2);
            const mq2Avg = mq2Values.reduce((a, b) => a + b, 0) / mq2Values.length;
            const mq2Max = Math.max(...mq2Values);
            if (mq2Max > mq2Avg * 1.5) {
                anomalies.push('烟雾浓度异常升高');
            }
            
            // 检查温度异常
            const tempValues = collectedData.map(d => d.temperature);
            const tempAvg = tempValues.reduce((a, b) => a + b, 0) / tempValues.length;
            const tempMax = Math.max(...tempValues);
            if (tempMax > tempAvg * 1.2 || tempMax > 30) {
                anomalies.push('温度异常升高');
            }
            
            // 检查湿度异常
            const humValues = collectedData.map(d => d.humidity);
            const humAvg = humValues.reduce((a, b) => a + b, 0) / humValues.length;
            const humMax = Math.max(...humValues);
            if (humMax > humAvg * 1.3 || humMax > 80) {
                anomalies.push('湿度过高');
            }
            
            // 构建结果
            let result = '<h4>异常检测结果</h4>';
            if (anomalies.length > 0) {
                result += '<div class="ai-alert">';
                result += '<strong>发现以下异常：</strong><br>';
                anomalies.forEach(a => {
                    result += `- ${a}<br>`;
                });
                result += '</div>';
                result += '<div class="ai-suggestion">';
                result += '<strong>建议：</strong><br>';
                if (anomalies.includes('烟雾浓度异常升高')) {
                    result += '- 请检查是否有烟雾或火灾隐患<br>';
                }
                if (anomalies.includes('温度异常升高')) {
                    result += '- 请检查空调系统是否正常工作<br>';
                }
                if (anomalies.includes('湿度过高')) {
                    result += '- 请启动除湿设备<br>';
                }
                result += '</div>';
            } else {
                result += '<p style="color: #28a745; text-align: center;">未发现异常，环境参数正常</p>';
            }
            
            return { html: result };
        }
        
        // 趋势预测功能
        function predictTrends(data) {
            // 检查是否有足够的数据进行预测
            if (collectedData.length < 20) {
                return { message: '数据不足，无法进行趋势预测。请至少收集20分钟的数据。' };
            }
            
            // 基于最后10个数据点进行简单预测
            const lastData = collectedData.slice(-10);
            
            // 计算温度趋势
            const tempValues = lastData.map(d => d.temperature);
            const tempTrend = tempValues[tempValues.length - 1] - tempValues[0];
            
            // 计算湿度趋势
            const humValues = lastData.map(d => d.humidity);
            const humTrend = humValues[humValues.length - 1] - humValues[0];
            
            // 构建预测结果
            let result = '<h4>未来2小时趋势预测</h4>';
            
            result += '<div class="ai-prediction">';
            result += '<strong>温度趋势：</strong>';
            if (Math.abs(tempTrend) < 0.5) {
                result += '温度保持稳定<br>';
            } else if (tempTrend > 0) {
                result += `温度将持续上升，预计2小时后升高${(tempTrend * 2).toFixed(1)}°C<br>`;
            } else {
                result += `温度将持续下降，预计2小时后降低${(Math.abs(tempTrend) * 2).toFixed(1)}°C<br>`;
            }
            result += '</div>';
            
            result += '<div class="ai-prediction">';
            result += '<strong>湿度趋势：</strong>';
            if (Math.abs(humTrend) < 1) {
                result += '湿度保持稳定<br>';
            } else if (humTrend > 0) {
                result += `湿度将持续上升，预计2小时后升高${(humTrend * 2).toFixed(1)}%<br>`;
            } else {
                result += `湿度将持续下降，预计2小时后降低${(Math.abs(humTrend) * 2).toFixed(1)}%<br>`;
            }
            result += '</div>';
            
            result += '<div class="ai-prediction">';
            result += '<strong>烟雾浓度：</strong>保持稳定<br>';
            result += '</div>';
            
            result += '<div class="ai-suggestion">';
            result += '<strong>建议：</strong><br>';
            if (tempTrend > 1) {
                result += '- 建议提前调整空调温度<br>';
            } else if (tempTrend < -1) {
                result += '- 建议减少供暖或关闭部分空调<br>';
            }
            if (humTrend > 2) {
                result += '- 建议提前开启除湿设备<br>';
            } else if (humTrend < -2) {
                result += '- 建议减少通风，保持室内湿度<br>';
            }
            result += '</div>';
            
            return { html: result };
        }
        
        // 节能优化建议功能
        function optimizeEnergy(data) {
            // 获取当前传感器数据
            const currentData = window.sensorData;
            
            // 构建节能建议
            let result = '<h4>节能优化建议</h4>';
            
            // 温度相关建议
            if (currentData.temperature > 26) {
                result += '<div class="ai-suggestion">';
                result += '<strong>温度优化：</strong><br>';
                result += '- 建议将空调温度调高1-2°C，可节约10-15%的制冷能耗<br>';
                result += '- 建议在人员较少的区域适当提高温度设置<br>';
                result += '</div>';
            } else if (currentData.temperature < 20) {
                result += '<div class="ai-suggestion">';
                result += '<strong>温度优化：</strong><br>';
                result += '- 建议将供暖温度调低1-2°C，可节约8-12%的供暖能耗<br>';
                result += '- 建议在无人区域关闭供暖或降低温度设置<br>';
                result += '</div>';
            }
            
            // 湿度相关建议
            if (currentData.humidity > 70) {
                result += '<div class="ai-suggestion">';
                result += '<strong>湿度优化：</strong><br>';
                result += '- 建议使用节能型除湿设备，避免过度除湿<br>';
                result += '- 建议在湿度较低的时段开窗通风<br>';
                result += '</div>';
            }
            
            // 通用节能建议
            result += '<div class="ai-suggestion">';
            result += '<strong>通用建议：</strong><br>';
            result += '- 建议根据实时人员流量调整环境控制设备运行状态<br>';
            result += '- 建议在非开放时间降低环境控制强度<br>';
            result += '- 建议定期检查环境控制设备的运行效率<br>';
            result += '</div>';
            
            return { html: result };
        }
        
        // AI分析按钮事件监听
        document.getElementById('aiAnalyzeBtn').addEventListener('click', async () => {
            if (collectedData.length === 0) {
                alert('请先收集一些数据再进行分析！');
                return;
            }
            
            try {
                const result = await callAIApi('analyze', collectedData);
                const aiResults = document.getElementById('aiResults');
                
                if (result.html) {
                    aiResults.innerHTML = result.html;
                } else {
                    aiResults.innerHTML = `<p style="color: #dc3545;">${result.message}</p>`;
                }
            } catch (error) {
                console.error('AI分析失败:', error);
                const aiResults = document.getElementById('aiResults');
                aiResults.innerHTML = `<p style="color: #dc3545;">分析失败：${error.message}</p>`;
            }
        });
        
        // AI预测按钮事件监听
        document.getElementById('aiPredictBtn').addEventListener('click', async () => {
            if (collectedData.length === 0) {
                alert('请先收集一些数据再进行预测！');
                return;
            }
            
            try {
                const result = await callAIApi('predict', collectedData);
                const aiResults = document.getElementById('aiResults');
                
                if (result.html) {
                    aiResults.innerHTML = result.html;
                } else {
                    aiResults.innerHTML = `<p style="color: #dc3545;">${result.message}</p>`;
                }
            } catch (error) {
                console.error('AI预测失败:', error);
                const aiResults = document.getElementById('aiResults');
                aiResults.innerHTML = `<p style="color: #dc3545;">预测失败：${error.message}</p>`;
            }
        });
        
        // AI优化建议按钮事件监听
        document.getElementById('aiOptimizeBtn').addEventListener('click', async () => {
            try {
                const result = await callAIApi('optimize', window.sensorData);
                const aiResults = document.getElementById('aiResults');
                
                if (result.html) {
                    aiResults.innerHTML = result.html;
                } else {
                    aiResults.innerHTML = `<p style="color: #dc3545;">${result.message}</p>`;
                }
            } catch (error) {
                console.error('AI优化建议失败:', error);
                const aiResults = document.getElementById('aiResults');
                aiResults.innerHTML = `<p style="color: #dc3545;">获取建议失败：${error.message}</p>`;
            }
        });
    </script>
</body>
</html>